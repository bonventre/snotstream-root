<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Sno+ Monitoring</title>
    <script src="js/json2.js"></script>
    <script src="js/jquery-1.7.js"></script> 
    <script src="js/jquery.jqplot.js"></script>
    <script src="js/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script src="js/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
    <script src="js/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script src="js/plugins/jqplot.barRenderer.min.js"></script>
    <script src="js/histogram.js"></script>
    <link type="text/css" rel="stylesheet" href="css/style.css">
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans"/> 
    <link rel="shortcut icon" href="images/favicon.ico"/>
    <style>
      .vmenu{border:1px solid #aaa;position:absolute;background:#fff; display:none;font-size:0.75em;}
      .vmenu .first_li span{width:100px;display:block;padding:5px 10px;cursor:pointer}
      .vmenu .inner_li{display:none;margin-left:120px;position:absolute;border:1px solid #aaa;
        border-left:1px solid #ccc;margin-top:-28px;background:#fff;}
      .vmenu .sep_li{border-top: 1px ridge #aaa;margin:5px 0}
      .vmenu .fill_title{font-size:11px;font-weight:bold;/height:15px;/overflow:hidden;word-wrap:break-word;}
    </style>
  </head>

  <body>
    <div id="header"></div>
    <br/>

    <div id="content">
      <div id="nhitchart" style="margin:50px;height:400px;width:500px;" class="plot"></div>
      <div class="vmenu">
        <div class="first_li"><span>Clear</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Stop</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Load 5</span></div>
        <div class="first_li"><span>Load 10</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Rebin</span></div>
      </div>
      <div id="crateeventchart" style="margin:50px;height:400px;width:500px;" class="plot"></div>
      <div class="vmenu">
        <div class="first_li"><span>Clear</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Stop</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Load 5</span></div>
        <div class="first_li"><span>Load 10</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Rebin</span></div>
      </div>

    </div>
    <div id="footer"></div>
  </body>

  <script>
    $(document).ready(function() {
      $("#header").load("header.html");
      $("#footer").load("footer.html");

      $('.plot').bind('contextmenu',function(e){
        var $cmenu = $(this).next();
        $('<div class="overlay"></div>').css({left:'0px',top:'0px',position:'absolute',width:'100%',height:'100%',zIndex:'100'}).click(function(){
          $(this).remove();
          $cmenu.hide();
        }).bind('contextmenu',function(){return false;}).appendTo(document.body);
        $(this).next().css({left: e.pageX, top: e.pageY, zIndex: '101'}).show();
        return false;
      });

      $('.vmenu .first_li').live('click',function(){
        if ($(this).text() == "Stop"){
          stop = 1;
          $(this).html("<span>Start</span>");
          lastkey = -1;
        }
        else if ($(this).text() == "Clear"){
          for (var i=0;i<100;i++){
            nhitplot.series[0].data[i][1] = 0;
            nhitplot.series[1].data[i][1] = 0;
          }
          nhitplot.replot({resetAxes:true});
          firstkey = -1;
          lastkey = -1;
        }
        else if ($(this).text() == "Load 5"){
          clearTimeout(t);
          history(5);
          t = setTimeout(timer,500);
        }
        else if ($(this).text() == "Load 10"){
          clearTimeout(t);
          history(10);
          t = setTimeout(timer,500);
        }
        else if ($(this).text() == "Stop"){
          $(this).html("<span>Stop</span>");
          stop = 0;
          clearTimeout(t);
          timer(1);
        }
        else if ($(this).text() == "Rebin"){
          var numbins = prompt("How many bins??","5");
          nhitplot.rebin(parseInt(numbins));
        }

        $('.vmenu').hide();
        $('.overlay').hide();
      });


      var jsonurl = "./data"

      var nhitplot = new histogram('nhitchart',2,50,0,500,{
        title: 'Histogram',
        stackSeries:true,
        linesPerBin: false,
        sumhist: true,
        seriesDefaults:{renderer:$.jqplot.BarRenderer,
          rendererOptions:{
            barMargin: 1
        }},
        axes:{
          xaxis: {
            tickRenderer: $.jqplot.CanvasAxisTickRenderer,
            tickOptions: {formatString: "%d"}
          },
          yaxis:{
            min: 0,
            tickRenderer: $.jqplot.CanvasAxisTickRenderer,
            tickOptions: {formatString: "%3.1f "}
          }
        }
      });
      
      function update(howmany) {
        var tempurl = jsonurl;
        tempurl += "?nhit=" + lastkey;
        $.ajax({
          async: false,
          url: tempurl,
          dataType:"json",
          success: function(data){
            parsedata(data);
          },
          error: function(jqXHR, textStatus, errorThrown){
            console.log(errorThrown);
          }
        });
        nhitplot.replot();
      }

      function history(howmany){
        if (firstkey != 0){
          var tempurl = jsonurl + "?history=nhit&startkey=" + (firstkey-howmany) + "&endkey=" + (firstkey-1);
          $.ajax({
            async: false,
            url: tempurl,
            dataType:"json",
            success: function(data){
              parsehistory(data);
            },
            error: function(jqXHR, textStatus, errorThrown){
              console.log(errorThrown);
            }
          });
          nhitplot.replot();
        }
      }

      function parsehistory(fulldata){
        var data = fulldata[1];
        var maxkey = fulldata[0][1];
        var minkey = fulldata[0][0];

        if (maxkey >= 0){
          if (firstkey < 0 || minkey < firstkey){
            firstkey = minkey;
          }
          if (lastkey < 0){
            lastkey = maxkey;
          }
        }
        nhitplot.sum_items(data);
      }

      function parsedata(fulldata){
        fulldata = fulldata['nhit'];
        var data = fulldata[1];
        var maxkey = fulldata[0];
        var minkey = maxkey - data.length + 1;

        if (maxkey >= 0){
          if (firstkey < 0){
            firstkey = minkey;
          }
          lastkey = maxkey;
        }
        nhitplot.sum_items(data);
      }

      function timer(howmany){
        if (stop == 1){
          return;
        }
        update(howmany);
        t = setTimeout(timer,500);
      }

      // last key gets cleared when you clear the data or stop the plot
      // that way when you restart it, you only get one item, not everything that
      // happened since you stopped it
      lastkey = -1;
      // firstkey gets cleared when you clear the data, otherwise stays.
      firstkey = -1;
      timer(1);
    });
  </script>
</html>

