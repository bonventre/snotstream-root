<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Sno+ Monitoring</title>
    <script src="js/json2.js"></script>
    <script src="js/jquery-1.7.js"></script> 
    <script src="js/jquery.jqplot.js"></script>
    <script src="js/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script src="js/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="js/plugins/jqplot.barRenderer.min.js"></script>
    <link type="text/css" rel="stylesheet" href="css/style.css">
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans"/> 
    <link rel="shortcut icon" href="images/favicon.ico"/>
    <style>
      .vmenu{border:1px solid #aaa;position:absolute;background:#fff; display:none;font-size:0.75em;}
      .vmenu .first_li span{width:100px;display:block;padding:5px 10px;cursor:pointer}
      .vmenu .inner_li{display:none;margin-left:120px;position:absolute;border:1px solid #aaa;
        border-left:1px solid #ccc;margin-top:-28px;background:#fff;}
      .vmenu .sep_li{border-top: 1px ridge #aaa;margin:5px 0}
      .vmenu .fill_title{font-size:11px;font-weight:bold;/height:15px;/overflow:hidden;word-wrap:break-word;}
    </style>
  </head>

  <body>
    <div id="header"></div>
    <br/>

    <div id="content">
      <div id="chartdiv" style="margin:50px;height:400px;width:95%; "></div>
      <div class="vmenu">
        <div class="first_li"><span>Clear</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Stop</span></div>
        <div class="sep_li"></div>
        <div class="first_li"><span>Load 5</span></div>
        <div class="first_li"><span>Load 10</span></div>
      </div>
    </div>
    <div id="pointinfo">
    </div>

    <div id="footer"></div>
  </body>

  <script>
    $(document).ready(function() {
      $("#header").load("header.html");
      $("#footer").load("footer.html");

      $('#chartdiv').bind('contextmenu',function(e){
        var $cmenu = $(this).next();
        $('<div class="overlay"></div>').css({left:'0px',top:'0px',position:'absolute',width:'100%',height:'100%',zIndex:'100'}).click(function(){
        $(this).remove();
        $cmenu.hide();
      }).bind('contextmenu',function(){return false;}).appendTo(document.body);
      $(this).next().css({left: e.pageX, top: e.pageY, zIndex: '101'}).show();
      return false;
    });

    $('.vmenu .first_li').live('click',function(){
      if ($(this).text() == "Stop"){
        stop = 1;
        $(this).html("<span>Start</span>");
      }
      else if ($(this).text() == "Clear"){
        for (var i=0;i<100;i++){
          plot2.series[0].data[i][1] = 0;
          plot2.series[1].data[i][1] = 0;
        }
        plot2.replot({resetAxes:true});
        currentkey = 0;
        startkey = 0;
      }
      else if ($(this).text() == "Load 5"){
        clearTimeout(t);
        history(5);
        t = setTimeout(timer,500);
      }
      else if ($(this).text() == "Load 10"){
        clearTimeout(t);
        history(10);
        t = setTimeout(timer,500);
      }
      else{
        $(this).html("<span>Stop</span>");
        stop = 0;
        clearTimeout(t);
        timer(1);
      }

      $('.vmenu').hide();
      $('.overlay').hide();
    });

    $("#chartdiv").bind("jqplotDataClick",function(ev,seriesIndex,pointIndex,data){
      var channum = pointIndex%32
      var slotnum = (pointIndex-channum)/16;
      data = data[1];
      if (seriesIndex == 1){
        $("#pointinfo").html(data + " new events in Slot " + slotnum + ", Channel " + channum);
      }
      else{
        $("#pointinfo").html("Slot " + slotnum + ", Channel " + channum + ": " + data);
      }
    });

    var ajaxDataRenderer = function(url, plot, options){
      var ret = null;
      $.ajax({
        async: false,
        url: url,
        dataType:"json",
        success: function(data){
          ret = data;
        },
        complete: function(jqXHR,textStatus){
          console.log(jqXHR);
          console.log(textStatus);
        }
      });
      return ret;
    }

    var jsonurl = "./data"

    var summed = [];
    var adding = [];
    for (var i=0;i<100;i++){
      summed[i] = 0;
      adding[i] = 0;
    }
    var stop = 0;
    var plot2 = $.jqplot('chartdiv',[summed,adding],{
      stackSeries: true,
      seriesDefaults:{
        renderer:$.jqplot.BarRenderer,
        rendererOptions: {
          barWidth: 4,
        },
        pointLabels: {show: true}
      },
      axes: {
        xaxis: {
          renderer: $.jqplot.CategoryAxisRenderer,
          label:'Nhit',
          labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
          pad: 1
        },
        yaxis: {
          label:'Count',
          labelRenderer: $.jqplot.CanvasAxisLabelRenderer
        }
      }
    });

    function update(howmany) {
      var tempurl = jsonurl;
      tempurl += "?key=" + currentkey;
      for (var i=0;i<100;i++){
        plot2.series[0].data[i][1] += plot2.series[1].data[i][1];
      }
      $.ajax({
        async: false,
        url: tempurl,
        dataType:"json",
        success: function(data){
          parsedata(data);
        },
        error: function(jqXHR, textStatus, errorThrown){
          console.log(errorThrown);
        }

      });
      plot2.replot({resetAxes:true});
    }

    function history(howmany){
      var tempurl = jsonurl + "?startkey=" + (startkey-howmany) + "&endkey=" + startkey;
      for (var i=0;i<100;i++){
        plot2.series[0].data[i][1] += plot2.series[1].data[i][1];
      }
      $.ajax({
        async: false,
        url: tempurl,
        dataType:"json",
        success: function(data){
          parsehistory(data);
        },
        error: function(jqXHR, textStatus, errorThrown){
          console.log(errorThrown);
        }

      });
      plot2.replot({resetAxes:true});
 
    }

    function parsehistory(fulldata){
      console.log(fulldata);
      data = fulldata[1];
      if (startkey == 0){
        currentkey = fulldata[0][1];
      }
      startkey = fulldata[0][0];
      var temp = [];
      for (var i=0;i<100;i++){
        temp[i] = [i+1,0];
      }
      for (var i=0;i<data.length;i++){1
        var x=0;
        while (((x+1)*5)<data[i] && x<99){
          x++;
        }
        temp[x][1]++; 
      }
      plot2.series[1].data = temp;

    }

    function parsedata(fulldata){
      console.log(currentkey);
      console.log(fulldata);
      if (currentkey == 0){
        startkey = fulldata[0] - fulldata[1].length;
      }
      currentkey = fulldata[0];
      data = fulldata[1];
      var temp = [];
      for (var i=0;i<100;i++){
        temp[i] = [i+1,0];
      }
      for (var i=0;i<data.length;i++){1
        var x=0;
        while (((x+1)*5)<data[i] && x<99){
          x++;
        }
        temp[x][1]++; 
      }
      plot2.series[1].data = temp;
    }

    function timer(howmany){
      if (stop == 1){
        return;
      }
      update(howmany);
      t = setTimeout(timer,500);
    }

    currentkey = 0;
    startkey = 0;
    timer(1);

    /*
    var plot0 = $.jqplot('chartdiv',  [[[1, 2],[3,5.12],[5,13.1],[7,33.6],[9,85.9],[11,219.9]]],{
      axes:{
        xaxis:{
          label:'Angle (radians)',
          labelRenderer: $.jqplot.CanvasAxisLabelRenderer
        },
        yaxis:{
          label:'Cosine',
          labelRenderer: $.jqplot.CanvasAxisLabelRenderer
        }
      }

    });
    var i = 0;

    function update() {
      if (i%2 == 0){
        plot0.series[0].data = [[0,0],[1,1],[2,-1],[3,3]];
        plot0.replot({resetAxes:true});
        i++;
        }else{
        plot0.series[0].data = [[0,0],[1,-1],[2,2],[3,0]];
        plot0.replot({resetAxes:true});
        i=0;
      }
      setTimeout(update, 500);
    }

    update();
    */


  });
</script>
</html>

